---
title: "HW5"
author: "Bedros, Haig; Dela Cruz, Sandra; Hugh, Tiffany; Li, Yanyi"
date: "`r Sys.Date()`"
output:
editor_options: 
  markdown: 
    wrap: 72
---
<style type="text/css">

h1.title {
  font-size: 26px;
  color: Black;
  text-align: center;
}
h4.author { 
  font-size: 18px;
  color: Black;
  text-align: center;
}
h4.date {
  font-size: 12px;
  color: Black;
  text-align: center;
}
</style>
```{r setup, include=FALSE}
knitr::opts_chunk$set(tidy.opts = list(width.cutoff = 50), tidy = TRUE, warning = FALSE)
```

```{r, include=FALSE}
library(dplyr)
library(stringr)
library(ggplot2)
library(tidyr)
library(purrr)
library(DataExplorer)
library(reshape2)
library(pROC)
library(readr)
library(caret)
library(DHARMa)
library(lares)
library(mice)
```

```{r, include=FALSE}
# Import dataset
wine_training_data <- read_csv("https://raw.githubusercontent.com/tiffhugh/DATA-621/refs/heads/main/Assignment%20%235/wine-training-data.csv")
wine_evaluation_data<- read_csv("https://raw.githubusercontent.com/tiffhugh/DATA-621/refs/heads/main/Assignment%20%235/wine-evaluation-data.csv")
```

# **Data Exploration**
First, let's remove the 'INDEX' column in both of the dataset, since we are not going to need it.
```{r, echo=FALSE}
# remove index columns
wine_training_data <- wine_training_data %>% select(-INDEX)
glimpse(wine_training_data)
dim(wine_training_data)

# do the same for evaluation data
wine_evaluation_data <- wine_evaluation_data %>% select(-IN)
```
Our wine training dataset has 12,795 observations and 15 columns. As we can see, there are a lot of data transformations that needs to be done with our variables, like cleaning our values and changing the columns into categorical values, like for `LabelAppeal` and `STARS`.

### Data Transformation of Variables
First, we clean the data by removing leading hyphens (-) from numeric values, as chemical concentrations cannot be negative, and such entries likely result from formatting errors.
```{r, echo=FALSE}
# clean the values in our variables by removing hyphens
wine_training_data <- wine_training_data %>% 
  mutate(across(-LabelAppeal, ~gsub("-", "", .x)))
glimpse(wine_training_data)

wine_evaluation_data <- wine_evaluation_data %>%
  mutate(across(-LabelAppeal, ~gsub("-", "", .x)))
```
Now that we have removed unnecessary characters in our values, let's review our distinct values.
```{r, echo=FALSE}
# check distinct values for all columns
wine_training_data %>% summarise(across(everything(), ~n_distinct(.)))

# check unique values in possibly ordinal columns
wine_training_data %>% 
  distinct(LabelAppeal, STARS) %>% 
  map(~unique(.))
```
As we can see, 'NA' is present for the `STARS` column. Later we'll impute those with values using "polr" from the MICE package, considering it's a ordinal categorical column.

Now, let's proceed with converting our columns to the appropriate data types, such as numeric, or ordinal variables:
Convert to numeric variables: `TARGET`, `FixedAcidity`, `VolatileAcidity`, `CitricAcid`, `ResidualSugar`, `Chlorides`, `FreeSulfurDioxide`, `TotalSulfurDioxide`, `Density`, `pH`, `Sulphates`, `Alcohol`, `AcidIndex`
Convert to ordinal variables: `STARS`, `LabelAppeal`
```{r, echo=FALSE}
wine_training_data <- wine_training_data %>% 
  mutate(
    # convert all numeric variables
    across(c(TARGET, FixedAcidity, VolatileAcidity, CitricAcid, 
             ResidualSugar, Chlorides, FreeSulfurDioxide, TotalSulfurDioxide, 
             Density, pH, Sulphates, Alcohol, AcidIndex), as.numeric),
    # convert all ordinal variables
    across(c(STARS, LabelAppeal), as.ordered)
  )

glimpse(wine_training_data)

# do the same for evaluation data
wine_evaluation_data <- wine_evaluation_data %>% 
  mutate(
    # convert all numeric variables
    across(c(TARGET, FixedAcidity, VolatileAcidity, CitricAcid, 
             ResidualSugar, Chlorides, FreeSulfurDioxide, TotalSulfurDioxide, 
             Density, pH, Sulphates, Alcohol, AcidIndex), as.numeric),
    # convert all ordinal variables
    across(c(STARS, LabelAppeal), as.ordered)
  )
```
### Summary of Datasets
In our dataset, missing values (NA) appear in variables such as `ResidualSugar`, `Chlorides`, `FreeSulfurDioxide`, `TotalSulfurDioxide`, `pH`, `Sulphates`, `Alcohol`, and `STARS`. We plan to address these through appropriate imputation techniques, including median imputation, Predictive Mean Matching (PPM) for continuous variables, or proportional odds logistic regression (polr) via the `mice` package for ordinal categorical variables like STARS, depending on variable distribution.

From our summary, some extreme values also warrant attention. For instance, `FixedAcidity` values greater than 16 g/L are chemically improbable, as white wines typically range between 4–10 g/L and red wines 4–16 g/L. For `FreeSulfurDioxide`, values exceeding 350 mg/L surpass US regulatory limits, and EU limits are even lower (~150 mg/L). Given the lack of country-specific data, we’ll apply US thresholds. Similar logic applies to `TotalSulfurDioxide`.

We will flag values that exceed these thresholds, treat them as missing, and impute accordingly to reduce bias and ensure realistic modeling.

However, for variables like `ResidualSugar`, `Density`, and `Alcohol`, we’ll retain outliers—such as those seen in sweet and fortified wines (e.g., Tokaji, Sherry)—as they represent valid cases. We’ll reassess how best to impute missing values in variables such as `pH`, `Sulphates`, `Alcohol`, `ResidualSugar`, and `Chlorides`.
```{r, echo=FALSE}
#| fig-height: 3
#| fig-width: 8
cat("Summary of training data: \n")
summary(wine_training_data)
```
### Plots for Visual Assesment
Below we can see that most of our variables are skewed to the right, only `ph` and `Density` are somewhat normally distributed.
```{r, echo=FALSE}
#| fig-height: 5
#| fig-width: 10
cat("Histogram of training data: \n")
plot_histogram(wine_training_data)
cat("Density Plot of training data: \n")
plot_density(wine_training_data)
cat("Boxplot of training data: \n")
plot_boxplot(wine_training_data, by='TARGET')
cat("Barplot of training data: \n")
plot_bar(wine_training_data)
```
### Visual Correlation of Variables
```{r, echo=FALSE, message=FALSE}
#| fig-height: 5
#| fig-width: 10
corr_cross(wine_training_data, 
           method = "spearman", max_pvalue = 0.05, top = 20)

corr_cross(wine_training_data, 
           method = "spearman", max_pvalue = 0.05, 
           contains = c('TARGET'))
```
To visualize correlations, we use the `corr_cross()` function from the `lares` package, which allows for an easy comparison across variables. We set the method to Spearman because most of our data is not normally distributed.

From the resulting graphs, we observe that `TARGET` and `STARS_NAs` are strongly negatively correlated, though, as mentioned earlier, we will impute missing values for `STARS` later on.

Additionally, we note a correlation between `TARGET` and `STARS_3`, but the p-value is 0.377, indicating no statistically significant relationship, so it's not a concern for our analysis.

With these insights, we’re ready to move forward with the data preparation phase.

# **Data Preparation**
### Replace Extreme Variables With NA
First, let's replace the extreme values from the certain variables that we have:
Threshold of `FixedAcidity`: 16 g/L
Threshold of `FreeSulfurDioxide`: 350 mg/L
Threshold of `TotalSulfurDioxide`: 350 mg/L

```{r, echo=FALSE}
# Assuming your data frame is named df
wine_training_data <- wine_training_data %>%
  mutate(
    FixedAcidity = ifelse(FixedAcidity > 16, NA, FixedAcidity),
    FreeSulfurDioxide = ifelse(FreeSulfurDioxide > 350, NA, FreeSulfurDioxide),
    TotalSulfurDioxide = ifelse(TotalSulfurDioxide > 350, NA, TotalSulfurDioxide)
  )

summary(wine_training_data)

wine_evaluation_data <- wine_evaluation_data %>%
  mutate(
    FixedAcidity = ifelse(FixedAcidity > 16, NA, FixedAcidity),
    FreeSulfurDioxide = ifelse(FreeSulfurDioxide > 350, NA, FreeSulfurDioxide),
    TotalSulfurDioxide = ifelse(TotalSulfurDioxide > 350, NA, TotalSulfurDioxide)
  )
```
